<!DOCTYPE html>
<html>
<head>
    <title>Voice Chat Test</title>
</head>
<body>
    <h1>Voice Chat Test</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="sendTextBtn">Send Text</button>
    <input type="text" id="textInput" placeholder="Type a message">
    
    <div id="status">Status: Not connected</div>
    <div id="messages"></div>
    <audio id="audioPlayer" controls></audio>
    
   <script>
let ws;
let mediaRecorder;
let audioChunks = [];
let audioContext;
let sourceNode;

// Connect to WebSocket
function connect() {
    ws = new WebSocket('ws://localhost:8000/api/v1/ws/voice');
    
    ws.onopen = () => {
        console.log('WebSocket connected');
        document.getElementById('status').textContent = 'Status: Connected';
    };
    
    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'text') {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += `<p><strong>Bot:</strong> ${data.content}</p>`;
            } else if (data.type === 'audio') {
                // Convert hex to bytes and play
                const byteArray = new Uint8Array(data.data.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const blob = new Blob([byteArray], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(blob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;
                audioPlayer.play();
            }
        } catch (e) {
            console.log('Raw message:', event.data);
        }
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        document.getElementById('status').textContent = 'Status: Error';
    };
    
    ws.onclose = () => {
        console.log('WebSocket disconnected');
        document.getElementById('status').textContent = 'Status: Disconnected';
    };
}

// Start recording - FIXED VERSION
document.getElementById('startBtn').onclick = async () => {
    try {
        // Get microphone with specific format
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                sampleRate: 16000,
                channelCount: 1,
                echoCancellation: true,
                noiseSuppression: true
            }
        });
        
        // Create audio context for processing
        audioContext = new AudioContext({ sampleRate: 16000 });
        sourceNode = audioContext.createMediaStreamSource(stream);
        
        // Create processor to convert to PCM
        const processor = audioContext.createScriptProcessor(4096, 1, 1);
        
        let accumulatedPCM = new Int16Array(0);
        
        processor.onaudioprocess = (event) => {
            const inputData = event.inputBuffer.getChannelData(0);
            
            // Convert float32 to int16
            const pcmData = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
                const s = Math.max(-1, Math.min(1, inputData[i]));
                pcmData[i] = s < 0 ? s * 32768 : s * 32767;
            }
            
            // Accumulate PCM data
            const newAccumulated = new Int16Array(accumulatedPCM.length + pcmData.length);
            newAccumulated.set(accumulatedPCM);
            newAccumulated.set(pcmData, accumulatedPCM.length);
            accumulatedPCM = newAccumulated;
            
            // Send every ~2 seconds of audio (32000 samples at 16kHz)
            if (accumulatedPCM.length >= 32000) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(accumulatedPCM.buffer);
                    console.log(`Sent ${accumulatedPCM.length} PCM samples`);
                }
                accumulatedPCM = new Int16Array(0);
            }
        };
        
        // Connect nodes
        sourceNode.connect(processor);
        processor.connect(audioContext.destination);
        
        // Also use MediaRecorder for UI feedback
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
        });
        
        mediaRecorder.start();
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        
        console.log('Recording started with PCM conversion');
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Microphone access denied or not available');
    }
};

// Stop recording
document.getElementById('stopBtn').onclick = () => {
    if (audioContext) {
        audioContext.close();
    }
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        console.log('Recording stopped');
    }
};

// Connect on page load
window.onload = connect;
</script>
</body>
</html>