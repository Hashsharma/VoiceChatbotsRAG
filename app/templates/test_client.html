<!DOCTYPE html>
<html>
<head>
    <title>Voice Chat Test</title>
</head>
<body>
    <h1>Voice Chat Test</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="sendTextBtn">Send Text</button>
    <input type="text" id="textInput" placeholder="Type a message">
    
    <div id="status">Status: Not connected</div>
    <div id="messages"></div>
    <audio id="audioPlayer" controls></audio>
    
    <script>
        let ws;
        let mediaRecorder;
        let audioChunks = [];
        
        // Connect to WebSocket
        function connect() {
            ws = new WebSocket('ws://localhost:8000/api/v1/ws/voice');
            
            ws.onopen = () => {
                document.getElementById('status').textContent = 'Status: Connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'text') {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML += `<p><strong>Bot:</strong> ${data.content}</p>`;
                } else if (data.type === 'audio') {
                    // Convert hex to bytes
                    const byteArray = new Uint8Array(data.data.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                    
                    // Create audio blob and play
                    const blob = new Blob([byteArray], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                }
            };
            
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Status: Disconnected';
            };
        }
        
        // Start recording
        document.getElementById('startBtn').onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    // Convert to array buffer and send
                    event.data.arrayBuffer().then(buffer => {
                        const bytes = new Uint8Array(buffer);
                        ws.send(bytes);
                    });
                }
            };
            
            mediaRecorder.start(100); // Send data every 100ms
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        };
        
        // Stop recording
        document.getElementById('stopBtn').onclick = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        };
        
        // Send text message
        document.getElementById('sendTextBtn').onclick = () => {
            const text = document.getElementById('textInput').value;
            if (text && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'text',
                    content: text
                }));
                document.getElementById('messages').innerHTML += 
                    `<p><strong>You:</strong> ${text}</p>`;
                document.getElementById('textInput').value = '';
            }
        };
        
        // Connect on page load
        window.onload = connect;
    </script>
</body>
</html>